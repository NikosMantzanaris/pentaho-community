<!-- 
		This file is used by release engineering to build and publish Open BI Platform artifacts.
     	Please do not edit this file for use in a development environment.   Use dev_build.xml instead.
-->

<project name="Pentaho BI Platform Open Build" basedir="." default="publish-all">

  <property file="override.properties" />
  <property file="build.properties" />

  <property name="publishTo" value="publish-local" />

  <import file="build-res/subfloor.xml" />

  <!--=======================================================================
        set-build.id
    
        Sets a property build.id to the either "development" or the svn revision
        if in release mode
        ====================================================================-->
  <target name="set-build.id" unless="build.id" depends="install-antcontrib">
    <if>
      <istrue value="${release}" />
      <then>
        <antcallback target="svn-revision" return="svn.revision" />
        <property name="build.id" value="${svn.revision}" />
      </then>
      <else>
        <property name="build.id" value="development" />
      </else>
    </if>
  </target>


  <!--=======================================================================
        all
    
        cleans, resolves and publishes and generates javadoc for all platform 
        projects serially by order of dependency.
        Note: the release process depends on this target working this way, please
        talk to the release manager if you need to change this target.
        ====================================================================-->

  <target name="publish-all"
          depends="install-antcontrib"
          description="cleans, resolves, publishes and generates javadoc for all platform projects serially">
    <sequential>
      <property name="project.list"
                value="bi-platform-api,
			  											bi-platform-util,
			  											bi-platform-engine-core,
			  											bi-platform-test-foundation,
			  											bi-platform-engine-security,
			  											bi-platform-engine-services,
			  											bi-platform-repository,
			  											bi-platform-ui-foundation,
			  											bi-platform-plugin-services,
			  											bi-platform-plugin-actions,
			  											bi-platform-scheduler,
			  											bi-platform-legacy,
			  											bi-platform-web,
			  											bi-platform-web-servlet,
			  											bi-platform-web-portlet,
			  	                                        bi-platform-security-userroledao
	  	  												mantle" />
      <for list="${project.list}" param="module" trim="true">
        <sequential>
          <ant antfile="build.xml" dir="../@{module}" inheritAll="false">
            <property name="project.revision" value="${project.revision}"/>
            <property name="impl.productID" value="POBS"/>
            <target name="clean-all" />
            <target name="resolve" />
            <target name="${publishTo}" />
          </ant>
        </sequential>
      </for>
	  <ant antfile="build.xml" dir="../mantle" inheritAll="false">
	    <property name="project.revision" value="${project.revision}"/>
	  	<property name="impl.productID" value="POBS"/>
	  	<target name="clean-all" />
	  	<target name="resolve" />
        <target name="update-versions-string" />
	  	<target name="${publishTo}" />
      </ant>
      <ant antfile="build.xml" dir="../bi-platform-sample-data" inheritAll="false">
        <property name="project.revision" value="${project.revision}"/>
        <target name="${publishTo}" />
      </ant>
    </sequential>
  </target>

  <target name="javadoc-all" description="generates javadoc for all platform projects">
  	<path id="javadoc.classpath">
  	      <fileset dir="../">
  	      <include name="bi-platform-web-servlet/lib/*.jar" />
  	      </fileset>
  	    </path>
    
  	<!-- print the classpath to the sys out -->
  	<property name="delimitedClasspath" refid="javadoc.classpath"/>
  	<echo message="Classpath = ${delimitedClasspath}"/>
  	
    <javadoc destdir="dist/javadoc/docs/api"
             access="public"
             source="1.5"
             use="true"
             notree="false"
             nonavbar="false"
             noindex="false"
             splitindex="true"
             author="true"
             version="true"
             maxmemory="768M"
             nodeprecatedlist="false"
             nodeprecated="false"
             doctitle="Pentaho BI Platform documentation">
  	  <classpath refid="javadoc.classpath" />
      <link href="http://java.sun.com/j2se/1.5.0/docs/api/" />
      <fileset dir="../" defaultexcludes="yes">
        <include name="**/src/org/pentaho/**/*.java" />
      </fileset>
    </javadoc>
    
    <zip destfile="dist/biserver-ce-${project.revision}-javadoc.zip" basedir="dist/javadoc/"></zip>
  </target>

</project>
